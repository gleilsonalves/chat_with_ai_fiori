<mvc:View
    controllerName="com.sap.chatai.controller.Main"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.f"
    xmlns:layout="sap.ui.layout"
    xmlns="sap.m"
    height="100%">
    
    <Page
        id="page"
        title="{i18n>title}"
        showHeader="true"
        enableScrolling="false"
        class="sapUiContentPadding">
        
        <headerContent>
            <Button
                id="btnNewChat"
                icon="sap-icon://add"
                text="{i18n>newChat}"
                press=".onNewChat"
                type="Emphasized"/>
        </headerContent>

        <content>
            <f:DynamicPage
                id="dynamicPage"
                toggleHeaderOnTitleClick="false"
                headerExpanded="true"
                fitContent="true">
                
                <f:title>
                    <f:DynamicPageTitle>
                        <f:heading>
                            <Title text="{i18n>chatTitle}" />
                        </f:heading>
                    </f:DynamicPageTitle>
                </f:title>

                <f:content>
                    <VBox
                        id="chatContainer"
                        class="chatContainer">
                        
                        <!-- Lista de Conversas -->
                        <Panel
                            id="conversationsPanel"
                            headerText="{i18n>conversations}"
                            expandable="true"
                            expanded="true"
                            class="conversationsPanel"
                            visible="{= ${view>/currentConversationId} === null }">
                            
                            <List
                                id="conversationsList"
                                items="{
                                    path: '/',
                                    parameters: {
                                        $filter: 'sender_type eq \'USER\'',
                                        $orderby: 'created_at desc'
                                    }
                                }"
                                mode="SingleSelectMaster"
                                selectionChange=".onConversationSelect">
                                <StandardListItem
                                    title="{message_text}"
                                    description="{conversation_id}"
                                    type="Active"
                                    icon="sap-icon://discussion"
                                    info="{
                                        path: 'created_at',
                                        formatter: '.formatter.formatDate'
                                    }"/>
                            </List>
                        </Panel>

                        <!-- Área de Chat -->
                        <VBox
                            id="chatArea"
                            class="chatArea"
                            visible="{= ${view>/currentConversationId} !== null }">
                            
                            <Toolbar>
                                <Button
                                    icon="sap-icon://nav-back"
                                    press=".onBackToConversations"
                                    tooltip="{i18n>back}"/>
                                <ToolbarSpacer/>
                                <Title text="{i18n>chatActive}" level="H3"/>
                                <ToolbarSpacer/>
                                <Button
                                    icon="sap-icon://delete"
                                    press=".onDeleteConversation"
                                    tooltip="{i18n>deleteConversation}"
                                    type="Reject"/>
                            </Toolbar>

                            <!-- Mensagens do Chat -->
                            <ScrollContainer
                                id="messagesContainer"
                                height="calc(100vh - 300px)"
                                width="100%"
                                vertical="true"
                                horizontal="false"
                                class="messagesContainer">
                                
                                <VBox
                                    id="messagesBox"
                                    class="messagesBox">
                                    
                                    <items>
                                        {
                                            path: '/',
                                            parameters: {
                                                $filter: 'conversation_id eq \'' + ${view>/currentConversationId} + '\'',
                                                $orderby: 'message_id asc'
                                            }
                                        }
                                        <VBox class="{= ${sender_type} === 'USER' ? 'messageUser' : 'messageAI' }">
                                            <HBox class="messageHeader">
                                                <Avatar
                                                    src="{= ${sender_type} === 'USER' ? 'sap-icon://person-placeholder' : 'sap-icon://bot' }"
                                                    displaySize="XS"
                                                    class="messageAvatar"/>
                                                <Title
                                                    text="{= ${sender_type} === 'USER' ? ${i18n>you} : ${i18n>ai} }"
                                                    level="H5"
                                                    class="messageSender"/>
                                                <Label
                                                    text="{
                                                        path: 'created_at',
                                                        formatter: '.formatter.formatDateTime'
                                                    }"
                                                    class="messageTime"/>
                                            </HBox>
                                            <Text
                                                text="{message_text}"
                                                class="messageText"
                                                renderWhitespace="true"/>
                                        </VBox>
                                    </items>
                                </VBox>
                            </ScrollContainer>

                            <!-- Input de Mensagem -->
                            <Toolbar class="inputToolbar">
                                <TextArea
                                    id="messageInput"
                                    value="{view>/messageText}"
                                    placeholder="{i18n>typeMessage}"
                                    rows="2"
                                    width="100%"
                                    valueLiveUpdate="true"
                                    liveChange=".onMessageChange"
                                    submit=".onSendMessage"/>
                                <Button
                                    id="sendButton"
                                    icon="sap-icon://paper-plane"
                                    type="Emphasized"
                                    press=".onSendMessage"
                                    enabled="{= ${view>/messageText}.length > 0 }"
                                    tooltip="{i18n>send}"/>
                            </Toolbar>
                        </VBox>

                    </VBox>
                </f:content>
            </f:DynamicPage>
        </content>
    </Page>
</mvc:View>